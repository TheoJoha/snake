<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake</title>
    <link rel="stylesheet" href="./main.css">
</head>

<body>
    <script>

        // generate a grid
        function createGrid(n) {
            let grid = []
            for (let i = 0; i < n; i++) {
                grid.push([])
                for (let j = 0; j < n; j++) {
                    grid[i].push(' ')
                }
            }

            return grid
        }

        // place snake's body
        function createSnakeCords(n) {
            //check size of grid to place head in the middle
            let headPosition = (n - 1) / 2
            let snakeCooridnates = [[headPosition, headPosition], [headPosition + 1, headPosition], [headPosition + 2, headPosition]]
            return snakeCooridnates

        }

        // place snake on the grid
        function placeSnakeOnGrid(grid, snakeCords) {
            for (let i = 0; i < snakeCords.length; i++) {
                grid[snakeCords[i][0]][snakeCords[i][1]] = "o"
            }
            return grid
        }

        // update snake on the grid
        function updateSnakeOnGrid(grid, snakeCords, nextHead) {

            grid[nextHead[0]][nextHead[1]] = 'o'
            grid[snakeCords[snakeCords.length - 1][0]][snakeCords[snakeCords.length - 1][1]] = ' '

            return grid
        }

        // place apple
        function placeAppleOnGrid(grid) {
            let sizeOfGrid = grid.length - 1
            while (true) {
                let randomposition = randomPositionOnAGrid(sizeOfGrid)
                if (grid[randomposition[0]][randomposition[1]] == " ") {
                    grid[randomposition[0]][randomposition[1]] = "a"
                    return grid
                }
            }
        }

        // chose a random position on a grid
        function randomPositionOnAGrid(n) {
            let x = Math.floor((Math.random() * n))
            let y = Math.floor((Math.random() * n))
            return [x, y]
        }

        // move snake function
        function moveSnake(nextPosition, snakeCoordinates) {
            let newSnakeCoordinates = snakeCoordinates.slice(0, -1)
            newSnakeCoordinates.unshift(nextPosition)
            return newSnakeCoordinates
        }

        function appleCounter(nextHeadPosition, gridWithSnakeAndApple, numberOfApples) {
            if (gridWithSnakeAndApple[nextHeadPosition[0]][nextHeadPosition[1]] == 'a') {
                console.log(numberOfApples + 1)
                return numberOfApples + 1
            }
            return numberOfApples
        }

        function checkIfNextIsApple(nextHeadPosition, gridWithSnakeAndApple) {
            if (gridWithSnakeAndApple[nextHeadPosition[0]][nextHeadPosition[1]] == 'a') {
                return true
            }
            return false
        }

        function endGame() {
            alert("Game has ended!")
        }

        function checkNextHeadPosition(gridWithSnakeAndApple, snakeCoordinates, keyPressed) {
            console.log(keyPressed)
            let nextHead;
            if (keyPressed == "left" || keyPressed == "right" || keyPressed == "up" || keyPressed == "down") {
                if (keyPressed == "left") {
                    if (!(snakeCoordinates[0][0] == snakeCoordinates[1][0] + 1)) {
                        nextHead = [snakeCoordinates[0][0] - 1, snakeCoordinates[0][1]]
                    } else {
                        nextHead = [snakeCoordinates[0][0] + 1, snakeCoordinates[0][1]]
                    }
                }
                else if (keyPressed == "right") {
                    if (!(snakeCoordinates[0][0] == snakeCoordinates[1][0] - 1)) {
                        nextHead = [snakeCoordinates[0][0] + 1, snakeCoordinates[0][1]]
                    } else {
                        nextHead = [snakeCoordinates[0][0] - 1, snakeCoordinates[0][1]]
                    }
                }
                else if (keyPressed == "up") {
                    if (!(snakeCoordinates[0][1] == snakeCoordinates[1][1] - 1)) {
                        nextHead = [snakeCoordinates[0][1], snakeCoordinates[0][1] + 1]
                    } else {
                        nextHead = [snakeCoordinates[0][1], snakeCoordinates[0][1] - 1]
                    }
                }
                else if (keyPressed == "down") {
                    if (!(snakeCoordinates[0][1] == snakeCoordinates[1][1] + 1)) {
                        nextHead = [snakeCoordinates[0][1], snakeCoordinates[0][1] - 1]
                    } else {
                        nextHead = [snakeCoordinates[0][1], snakeCoordinates[0][1] + 1]
                    }           
                }

                return nextHead;
            }
            else {
                // case 1
                if (snakeCoordinates[0][0] == snakeCoordinates[1][0] - 1) {
                    nextHead = [snakeCoordinates[0][0] - 1, snakeCoordinates[0][1]]
                }
                // case 2
                else if (snakeCoordinates[0][0] == snakeCoordinates[1][0] + 1) {
                    nextHead = [snakeCoordinates[0][0] + 1, snakeCoordinates[0][1]]
                }
                // case 3
                else if (snakeCoordinates[0][1] == snakeCoordinates[1][1] - 1) {
                    nextHead = [snakeCoordinates[0][0], snakeCoordinates[0][1] - 1]
                }
                // case 4
                else if (snakeCoordinates[0][1] == snakeCoordinates[1][1] + 1) {
                    nextHead = [snakeCoordinates[0][0], snakeCoordinates[0][1] + 1]
                }
                return nextHead
            }
        }

        function checkIfNextHeadPositionIsValid(nextHeadPosition, gridWithSnakeAndApple) {
            if (nextHeadPosition[0] < 0 || nextHeadPosition[0] > gridWithSnakeAndApple.length - 1 ||
                nextHeadPosition[1] < 0 || nextHeadPosition[1] > gridWithSnakeAndApple.length - 1) {
                return false
            }
            else if (gridWithSnakeAndApple[nextHeadPosition[0]][nextHeadPosition[1]] == 'o') {
                return false
            }
            return true

        }

        function constructGridInDOM(grid) {
            let body = document.querySelector("body")
            for (let i = 0; i < grid.length; i++) {
                let outerDiv = document.createElement("div")
                outerDiv.style.backgroundColor = "gray"
                body.appendChild(outerDiv)
                for (let j = 0; j < grid.length; j++) {
                    let innerDiv = document.createElement("button")
                    innerDiv.style.backgroundColor = "blue"
                    if (grid[i][j] === " ") {
                        innerDiv.innerHTML = "&nbsp;"
                    } else {
                        innerDiv.innerHTML = grid[i][j]
                    }
                    outerDiv.appendChild(innerDiv)
                }
            }

        }

        // display apple score
        // also display high-score. This can be persisted with local storage

        // tick one step
        // check for any arrow-keydown events
        // check if snake is running into wall or own body -> end game
        // check if snake got apple
        // if got apple then add piece to snake's body and to apple score

        // when game is over display game over message with score and allow the user to press restart

        // display intro message when the game starts

        // different difficulty modes: eg. change speed, obstacles, etc.

        function main() {
            let n;
            let numberOfApples = 0
            let nextIsApple = false;
            var keyPressed = 'up';
            document.addEventListener("keydown", (e) => {
                    console.log(e.key)
                    if (e.key == "ArrowLeft") {
                        keyPressed = "left"
                    }
                    else if (e.key == "ArrowRight") {
                        keyPressed = "right"
                    }
                    else if (e.key == "ArrowUp") {
                        keyPressed = "up"
                    }
                    else if (e.key == "ArrowDown") {
                        keyPressed = "down"
                    }
                })
            while (true) {
                n = prompt("Input an uneven number between 10 and 20, inclusive, to choose the size of grid: ")
                if (n >= 10 && n <= 20 && n % 2 != 0) {
                    break
                }
            }
            let grid = createGrid(n)
            let snakeCoordinates = createSnakeCords(n)
            let gridWithSnake = placeSnakeOnGrid(grid, snakeCoordinates)
            let gridWithSnakeAndApple = placeAppleOnGrid(gridWithSnake)
            constructGridInDOM(gridWithSnakeAndApple)

            let intervalId = setInterval(() => {
            
                let nextHeadPosition = checkNextHeadPosition(gridWithSnakeAndApple, snakeCoordinates, keyPressed)

                let nextHeadPositionIsValid = checkIfNextHeadPositionIsValid(nextHeadPosition, gridWithSnakeAndApple)

                if (nextHeadPositionIsValid == false) {

                    clearInterval(intervalId)
                    endGame()
                }
                else {
                    numberOfApples = appleCounter(nextHeadPosition, gridWithSnakeAndApple, numberOfApples)
                    nextIsApple = checkIfNextIsApple(nextHeadPosition, gridWithSnakeAndApple)
                    gridWithSnake = updateSnakeOnGrid(gridWithSnakeAndApple, snakeCoordinates, nextHeadPosition)
                    snakeCoordinates = moveSnake(nextHeadPosition, snakeCoordinates)
                    if (nextIsApple) {
                        gridWithSnakeAndApple = placeAppleOnGrid(gridWithSnake)
                    }
                    console.log(gridWithSnakeAndApple)
                    // updateGridInDOM(gridWithSnakeAndApple)
                }

            }, 2000)
        }

        main()
    </script>
</body>

</html>